# Social Network Analysis (SNA) Pipeline for MNCLW Laws

This document explains the SNA pipeline implemented in `v2/term_finder/build_sna.py`.

## Overview
The pipeline builds a network where:
- **Nodes** are laws (e.g., MNCLW00001).
- **Edges** represent shared legal terms between laws.
- **Edge weights** reflect the strength of the similarity (Count, Jaccard, or TF-IDF).

## Files Created
- **v2/term_finder/build_sna.py**: Main script.
- **v2/term_finder/sna_utils.py**: Helper logic for parsing and math.
- **v2/tsv-data/**: Output directory for TSV files.

## Usage
Run the script from `v2/` directory:

```powershell
python v2/term_finder/build_sna.py --weight_mode raw
```

### CLI Arguments
- `--weight_mode`:
    - `raw`: Weight = number of unique terms shared.
    - `jaccard`: Weight = Intersection / Union of term sets (0.0 to 1.0).
    - `tfidf`: Weight = Sum of IDF values for shared terms. Rare terms contribute more.
- `--max_df`: (Default 0.30) Ignore terms that appear in more than 30% of all laws (stopwords-like).
- `--min_shared_terms`: (Default 1) Minimum overlapping terms required to form an edge.
- `--use`: `trie` (default) or `aho`. Which output files to parse.

## Methodology

### 1. Data Parsing
The script parses `trie-output.txt` files generated by the term finder. It handles whitespace-delimited columns robustly. It extracts the `Term` and counts occurrences.

### 2. Weight computation
- **Raw**: Simple count of shared terms. Good for seeing absolute overlap.
- **Jaccard**: Normalized overlap. Good for seeing structural similarity invariant to length.
- **TF-IDF**: Sum of Inverse Document Frequency (IDF) of shared terms.
    - $IDF(t) = \log(\frac{N}{DF(t)})$
    - This mode emphasizes laws that share *rare, specific* concepts rather than common words like "Law" or "Mongolia".

### 3. Metrics
The script computes and saves the following for each law in `law_node_stats.tsv`:
- **terms_unique**: Number of unique legal terms found in the law.
- **degree**: Number of connected laws (neighbors).
- **weighted_degree**: Sum of weights of incident edges.
- **betweenness**: (Centrality) Extent to which a law lies on shortest paths between others (using NetworkX).
- **closeness**: (Centrality) Reciprocal of the sum of shortest path distances.
- **pagerank**: Measure of influence (using NetworkX).
- **component_id**: ID of the connected component the law belongs to.

## Outputs (in v2/tsv-data/)

1.  **law_network_edges.tsv**:
    - Edge list for Gephi/Cytoscape.
    - Cols: `source_law`, `target_law`, `weight`, `shared_terms_count`, `shared_terms_sample`

2.  **law_node_stats.tsv**:
    - Node attributes.
    - Cols: `law_id`, `degree`, `betweenness`, etc.

3.  **law_term_presence.tsv**:
    - Raw counts of terms per law.
    - Cols: `law_id`, `term_id`, `leg_term`, `occurrences`

4.  **law_network_summary.txt**:
    - High-level stats: density, edge count, top influential laws.

## Change Log
- **2026-01-22**: Created `build_sna.py` and `sna_utils.py` to implement the full SNA pipeline. Added robust parsing for `trie-output.txt` and NetworkX integration.
